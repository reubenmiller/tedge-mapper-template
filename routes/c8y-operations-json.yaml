# yaml-language-server: $schema=../spec/schema.json
---
routes:
- name: c8y-devicecontrol-notifications
  topics:
    - c8y/devicecontrol/notifications
  template:
    type: jsonnet
    value: |
      # NB: Recurse the main object, looking for strings to replace
      local recurseReplace(any, from, to) = (
        {
          object: function(x) { [k]: recurseReplace(x[k], from, to) for k in std.objectFields(x) },
          array: function(x) [recurseReplace(e, from, to) for e in x],
          string: function(x) _.ReplacePattern(x, from, to),
          # string: function(x) std.strReplace(x, from, to),
          number: function(x) x,
          boolean: function(x) x,
          'function': function(x) x,
          'null': function(x) x,
        }[std.type(any)](any)
      );

      # Ref: https://groups.google.com/g/jsonnet/c/1nEJOYmS78I
      local m = {
          get(o, f, default)::
              local get_(o, ks) =
                  if ! std.objectHas(o, ks[0]) then
                      default
                  else if std.length(ks) == 1 then
                      o[ks[0]]
                  else
                      get_(o[ks[0]], ks[1:]);

              get_(o, std.split(f, '.')),
          
        has(o, f)::
          local has_(o, ks) =
              if ! std.objectHas(o, ks[0]) then
                  false
              else if std.length(ks) == 1 then
                  true
              else
                  has_(o[ks[0]], ks[1:]);
          has_(o, std.split(f, '.')),
        
        trimPrefix(s, prefix)::
          if s != '' && prefix != '' then
            if std.startsWith(s, prefix) then
              s[std.length(prefix):]
            else
              s
          else
            s
      };

      local trimPrefix = function(s, prefix)
        if s != '' && prefix != '' then
          if std.startsWith(s, prefix) then
            s[std.length(prefix):]
          else
            s
        else
          s
      ;

      local detectType = function(m, prefix='', defaultType='unknown')
        {
          local _matches = [
            item.key
            for item in std.objectKeysValues(m)
            if (std.isObject(item.value) || std.isArray(item.value)) && std.startsWith(item.key, prefix)
          ],
          type: if std.length(_matches) > 0 then _matches[0] else defaultType,
        };

      {
          message: {
            # Replace any internal urls with external ones
            payload: recurseReplace(
              message,
              'https?://\\bt\\d+\\.(cumulocity.com|latest.stage.c8y.io)',
              'https://' + std.get(meta, 'c8y_http', std.get(meta.env, 'TEDGE_ROUTE_C8Y_BASEURL', ''))
            ),
            _ctx: {
              local _ctx = self,
              local device_id = std.get(meta, 'device_id', ''),

              serial: m.get(message, 'externalSource.externalId', ''),
              localSerial: m.trimPrefix(_ctx.serial, device_id + '_'),

              deviceID: std.get(message, 'deviceId', ''),
              agentID: std.get(message, 'agentId', ''),
              operationID: std.get(message, 'id', ''),
              opType: detectType(message, 'c8y_', 'unknown').type,
              id: if _ctx.operationID != "" then _ctx.operationID else _.ID(),
            },
          },
          topic: 'c8y/devicecontrol/notifications/' + $.message._ctx.serial + '/' + $.message._ctx.opType,
          skip: $.message._ctx.serial == '',
          end: false,
      }

#
# Shell/Command operation
#
- name: shell-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_Command
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/' % [ctx.localSerial, partial]
      ;

      {
          message: {
            command: message.payload.c8y_Command,
            _request: message.payload,
          },
          topic: build_topic('operations/command'),
      }

#
# Restart
#
- name: restart-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_Restart
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/%s' % [ctx.localSerial, partial]
      ;
      {
          message: {},
          topic: build_topic('control/restart'),
      }

#
# Configuration
#
- name: upload-config-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_UploadConfigFile
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set' then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/%s' % [ctx.localSerial, partial]
      ;
      local params = std.get(message.payload, 'c8y_UploadConfigFile', {});
      {
          local configType = std.get(params, 'type', ''),
          message: {
            # Hide id for now
            id:: ctx.id,
            type: configType,
            url: 'http://0.0.0.0:8000/tedge/file-transfer/%s/%s/%s' % [ctx.serial, 'config_snapshot', configType],
          },
          topic: build_topic('config_snapshot'),
      }

- name: download-config-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_DownloadConfigFile
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/%s' % [ctx.localSerial, partial]
      ;
      local fragment = std.get(message.payload, 'c8y_DownloadConfigFile', {});
      {
          message: {
            type: std.get(fragment, 'type', ''),
            url: std.get(fragment, 'url', ''),
          },
          topic: build_topic('config_update'),
      }

#
# Software
#
- name: software-update-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_SoftwareUpdate
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%s/commands/req/%s' %[ctx.localSerial, partial]
      ;

      local defaultType = std.get(meta, 'software_plugin_default', 'apt');

      local types = std.set([
        std.get(item, 'softwareType', defaultType)
        for item in message.payload.c8y_SoftwareUpdate
      ]);

      {
        message: {
          id: ctx.id,
          updateList: [
            {
              type: type,
              modules: [
                {
                  name: std.get(software, 'name'),
                  version: std.strReplace(software.version, "::" + type, ""),
                  action: std.get(software, 'action', 'install'),
                }
                for software in message.payload.c8y_SoftwareUpdate
                if std.get(software, 'softwareType', defaultType) == type
              ]
            }
            for type in types
          ]
        },
        topic: build_topic('software/update'),
        context: false,
      }

#
# Firmware
#
- name: firmware-update-operation
  description: Incoming Firmware update operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_Firmware
  template:
    type: jsonnet
    value: |
      local build_tedge_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/%s' % partial
        else
          'tedge/%s/commands/%s' % [ctx.localSerial, partial]
      ;

      local params = std.get(message.payload, ctx.opType, {});
      assert 'name' in params : ".name is missing: opType=" + ctx.opType;

      {
        message: {
          id: if 'operationID' in ctx then ctx.operationID else ctx.id,
          device: ctx.localSerial,
          name: params.name,
          url: params.url,
          version: params.version,
          sha256: '',
        },
        topic: build_tedge_topic('firmware_update/start'),
        context: false,
      }

- name: firmware-update-operation-done
  description: Update the firmware list in Cumulocity
  topics:
    - tedge/+/commands/firmware_update/done/failed
    - tedge/+/commands/firmware_update/done/successful
  template:
    type: jsonnet
    value: |
      local prefix = std.split(topic, "/commands/")[0];

      # TODO: Get the status from the message body
      local status = std.split(topic, "/done/")[1];

      local sourceDevice = std.split(topic, '/')[1];
      local build_smartrest_topic = function(base_topic)
        local device_id = std.get(meta, 'device_id', '');

        if sourceDevice == device_id || sourceDevice == 'not-set'  then
          base_topic
        else
          '%s/%s' % [base_topic, device_id + '_' + sourceDevice]
      ;

      {
        updates: [
          {
            local firmwareName = std.get(message, 'name', ''),
            local firmwareVersion = std.get(message, 'version', ''),
            local firmwareUrl = std.get(message, 'url', ''),

            topic: build_smartrest_topic('c8y/s/us'),
            message: "115,%s,%s,%s" % [firmwareName, firmwareVersion, firmwareUrl],
          }
        ],
        topic: '%s/commands/firmware_update/done' % prefix,
        message: {status: status} + message,
        context: true,
      }

- name: set-operation-to-executing
  description: Set any Cumulocity operation to executing
  topics:
    - tedge/+/commands/+/executing
  template:
    type: jsonnet
    value: |
      assert 'id' in message : 'Message must container a .id value';
      {
        api: {
          path: "/devicecontrol/operations/%s" % message.id,
          method: "PUT",
        },
        message: message + {
          id:: null,
          startedAt: _.Now(),
          status: 'EXECUTING',
        },
        context: false,
      }

- name: set-operation-to-done
  description: Set any Cumulocity operation to either SUCCESSFUL or FAILED
  topics:
    - tedge/+/commands/+/done
  template:
    type: jsonnet
    value: |
      assert 'id' in message : 'Message must contain an .id property';
      assert 'status' in message : 'Message must contain an .status property';

      local c8yStatus = std.asciiUpper(message.status);

      {
        api: {
          path: "/devicecontrol/operations/%s" % message.id,
          method: "PUT",
        },
        message: message + {
          id:: null,  # id must be excluded from the update request
          status: c8yStatus,
          [if c8yStatus == "FAILED" then 'failureReason']: std.get(message, 'reason', 'no reason given'),
        },
        context: false,
      }

- name: deprecate-c8y-operation-update
  skip: true
  description: Generic Cumulocity update operation via REST API
  topics:
    - c8y/devicecontrol/notifications/+/c8y
  template:
    type: jsonnet
    value: |
      # Fail early if the operation is missing required data
      assert "id" in message : "Message must contain a .id property";
      assert "status" in message : "Message must contain a .status property";

      # Allowed operation statues
      local getOperationStatus = function(value)
        std.get(
          {
            successful: "SUCCESSFUL",
            failed: "FAILED",
            executing: "EXECUTING",
            pending: "PENDING",
          },
          std.asciiLower(value),
          'FAILED'
        )
      ;

      local status = getOperationStatus(message.status);
      {
        api: {
          path: "/devicecontrol/operations/%s" % message.id,
          method: "PUT",
        },
        message: message + {
          id:: null,  # id must be excluded from the update request
          status: status,
          [if status == "FAILED" then 'failureReason']: std.get(message, 'reason', 'no reason given'),
        },
        context: false,
      }

#
# Unknown operations
#
- name: unknown-operation
  topics:
    - c8y/devicecontrol/notifications/+/unknown
  template:
    type: jsonnet
    value: |
      {
          message: {
            text: 'Unknown operation type. Check the _request fragment to inspect the original message',
            _request: message.payload,
          },
          topic: 'tedge/events/unknown_operation',
      }


#
# Operation Transitions
#

#
# Software
#
- name: software update (main device)
  topics:
    - tedge/commands/res/software/update
  description: Handle the operation updates and send the status back to the cloud
  template:
    type: jsonnet
    value: |
      local id = std.get(message, 'id', 'unknown');
      local status = std.get(message, 'status', 'unknown');
      local reason = std.get(message, 'reason', 'unknown');

      local getTemplate = function(s)
        local states = {
          executing: '501,c8y_SoftwareUpdate',
          successful: '503,c8y_SoftwareUpdate',
          failed: '502,c8y_SoftwareUpdate,"%s"' % reason,
        };
        std.get(states, s, '400,tedge_custom_mapper,"Unexpected operation state. id=%s, state=%s"' % [id, s])
      ;

      {
        raw_message: getTemplate(status),
        topic: 'c8y/s/us',
      }

- name: software update (child devices)
  topics:
    - tedge/+/commands/res/software/update
  description: Handle the operation updates and send the status back to the cloud
  template:
    type: jsonnet
    value: |
      local id = std.get(message, 'id', 'unknown');
      local status = std.get(message, 'status', 'unknown');
      local reason = std.get(message, 'reason', 'unknown');

      # Check if tedge can be modified to preserve the _ctx property
      local device_id = std.get(meta, 'device_id', '');
      local local_serial = std.split(topic, "/")[1];
      local serial = if std.startsWith(local_serial, device_id) then
          local_serial
        else
          '%s_%s' % [device_id, local_serial]
        ;

      local getTemplate = function(s)
        local states = {
          executing: '501,c8y_SoftwareUpdate',
          successful: '503,c8y_SoftwareUpdate',
          failed: '502,c8y_SoftwareUpdate,"%s"' % reason,
        };
        std.get(states, s, '400,tedge_custom_mapper,"Unexpected operation state. id=%s, state=%s"' % [id, s])
      ;

      local types = std.set([
        item.type
        for item in std.get(message, 'currentSoftwareList', [])
      ]);

      local packages = [
        std.map(
          function(i) i + {type: type},
          std.filter(function(v) v.type == type, message.currentSoftwareList)[0].modules,
        )
        for type in types
      ];

      local toLegacySoftwareList = function(items)
        "116," + std.join(
          ",",
          std.map(
            function(item)
              "%s,%s,%s" % [item.name, item.version, std.get(item, 'url', '')],
            items,
          )
        )
      ;

      local toAdvancedSoftwareList = function(items)
        "140," + std.join(
          ",",
          std.map(
            function(item)
              "%s,%s,%s,%s" % [item.name, item.version, item.type, std.get(item, 'url', '')],
            items,
          )
        )
      ;

      local formatMessage = function(items, mode='')
        if mode == 'legacy' then
          toLegacySoftwareList(items)
        else
          toAdvancedSoftwareList(items)
      ;

      # Control which smart rest template id to use
      # either legacy or advanced. Defaults to advanced.
      local c8ySoftwareMode = '';

      {
        raw_message: getTemplate(status),
        [if std.length(packages) > 0 then 'updates']: [
          {topic: $.topic, message: formatMessage(packages[0], c8ySoftwareMode)},
        ],

        # TODO: replace serial with ctx.serial once the operation schema allow extra fields
        topic: 'c8y/s/us/%s' % serial,
      }
