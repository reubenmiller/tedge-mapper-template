# yaml-language-server: $schema=../spec/schema.json
---
routes:
- name: c8y-devicecontrol-notifications
  topics:
    - c8y/devicecontrol/notifications
  template:
    type: jsonnet
    value: |
      # NB: Recurse the main object, looking for strings to replace
      local recurseReplace(any, from, to) = (
        {
          object: function(x) { [k]: recurseReplace(x[k], from, to) for k in std.objectFields(x) },
          array: function(x) [recurseReplace(e, from, to) for e in x],
          string: function(x) _.ReplacePattern(x, from, to),
          # string: function(x) std.strReplace(x, from, to),
          number: function(x) x,
          boolean: function(x) x,
          'function': function(x) x,
          'null': function(x) x,
        }[std.type(any)](any)
      );

      local detectType = function(m, prefix='', defaultType='unknown')
        {
          local _matches = [
            item.key
            for item in std.objectKeysValues(m)
            if (std.isObject(item.value) || std.isArray(item.value)) && std.startsWith(item.key, prefix)
          ],
          type: if std.length(_matches) > 0 then _matches[0] else defaultType,
        };

      {
          message: {
            # Replace any internal urls with external ones
            payload: recurseReplace(
              message,
              'https?://\\bt\\d+\\.(cumulocity.com|latest.stage.c8y.io)',
              'https://' + std.get(meta, 'c8y_http', std.get(meta.env, 'TEDGE_ROUTE_C8Y_BASEURL', ''))
            ),
            _ctx: {
              local _ctx = self,
              local external_childid = _.Get(message, 'deviceExternalIDs.externalIds.0.externalId', null),
              local external_id = _.Get(message, 'externalSource.externalId', 'not-set'),
              local device_id = std.get(meta, 'device_id', ''),

              serial: if external_childid != null then external_childid else external_id, 
              localSerial: if std.startsWith(_ctx.serial, device_id) then _ctx.serial[std.length(device_id)+1:] else _ctx.serial,

              deviceID: std.get(message, 'deviceId', ''),
              agentID: std.get(message, 'agentId', ''),
              operationID: std.get(message, 'id', ''),
              opType: detectType(message, 'c8y_', 'unknown').type,
              id: _.ID(),
            },
          },
          topic: 'c8y/devicecontrol/notifications/' + $.message._ctx.serial + '/' + $.message._ctx.opType,
          end: false,
      }

- name: shell-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_Command
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/' % [ctx.localSerial, partial]
      ;

      {
          message: {
            command: message.payload.c8y_Command,
            _request: message.payload,
          },
          topic: build_topic('operations/command'),
      }

- name: restart-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_Restart
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/%s' % [ctx.localSerial, partial]
      ;
      {
          message: {},
          topic: build_topic('control/restart'),
      }

- name: upload-config-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_UploadConfigFile
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set' then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/%s' % [ctx.localSerial, partial]
      ;
      local params = std.get(message.payload, 'c8y_UploadConfigFile', {});
      {
          local configType = std.get(params, 'type', ''),
          message: {
            # Hide id for now
            id:: ctx.id,
            type: configType,
            url: 'http://0.0.0.0:8000/tedge/file-transfer/%s/%s/%s' % [ctx.serial, 'config_snapshot', configType],
          },
          topic: build_topic('config_snapshot'),
      }

- name: download-config-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_DownloadConfigFile
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/%s' % [ctx.localSerial, partial]
      ;
      local fragment = std.get(message.payload, 'c8y_DownloadConfigFile', {});
      {
          message: {
            type: std.get(fragment, 'type', ''),
            url: std.get(fragment, 'url', ''),
          },
          topic: build_topic('config_update'),
      }

- name: software-update-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_SoftwareUpdate
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%s/commands/req/%s' %[ctx.localSerial, partial]
      ;

      local defaultType = std.get(meta, 'software_plugin_default', 'apt');

      local types = std.set([
        std.get(item, 'softwareType', defaultType)
        for item in message.payload.c8y_SoftwareUpdate
      ]);

      {
        message: {
          id: ctx.id,
          updateList: [
            {
              type: type,
              modules: [
                {
                  name: std.get(software, 'name'),
                  version: std.strReplace(software.version, "::" + type, ""),
                  action: std.get(software, 'action', 'install'),
                }
                for software in message.payload.c8y_SoftwareUpdate
                if std.get(software, 'softwareType', defaultType) == type
              ]
            }
            for type in types
          ]
        },
        topic: build_topic('software/update'),
        end: true,
        context: false,
      }
  
- name: firmware-update-operation
  topics:
    - c8y/devicecontrol/notifications/+/c8y_Firmware
  template:
    type: jsonnet
    value: |
      local build_topic = function(partial)
        local device_id = std.get(meta, 'device_id', '');
        if ctx.serial == device_id || ctx.serial == 'not-set'  then
          'tedge/commands/req/' + partial
        else
          'tedge/%/commands/req/%s' % [ctx.localSerial, partial]
      ;

      local params = std.get(message.payload, ctx.opType, {});

      {
        message: {
          id: if 'operationID' in ctx then ctx.operationID else ctx.ID,
          name: params.name,
          url: params.url,
          version: params.version,
          sha256: '',
        },
        topic: build_topic('firmware_update'),
        end: true,
        context: false,
      }

- name: unknown-operation
  topics:
    - c8y/devicecontrol/notifications/+/unknown
  template:
    type: jsonnet
    value: |
      {
          message: {
            text: 'Unknown operation type. Check the _request fragment to inspect the original message',
            _request: message.payload,
          },
          topic: 'tedge/events/unknown_operation',
      }


#
# Operation Transitions
#
- name: software update (main device)
  topics:
    - tedge/commands/res/software/update
  description: Handle the operation updates and send the status back to the cloud
  template:
    type: jsonnet
    value: |
      local id = std.get(message, 'id', 'unknown');
      local status = std.get(message, 'status', 'unknown');
      local reason = std.get(message, 'reason', 'unknown');

      local getTemplate = function(s)
        local states = {
          executing: '501,c8y_SoftwareUpdate',
          successful: '503,c8y_SoftwareUpdate',
          failed: '502,c8y_SoftwareUpdate,"%s"' % reason,
        };
        std.get(states, s, '400,tedge_custom_mapper,"Unexpected operation state. id=%s, state=%s"' % [id, s])
      ;

      {
        raw_message: getTemplate(status),
        topic: 'c8y/s/us',
      }

- name: software update (child devices)
  topics:
    - tedge/+/commands/res/software/update
  description: Handle the operation updates and send the status back to the cloud
  template:
    type: jsonnet
    value: |
      local id = std.get(message, 'id', 'unknown');
      local status = std.get(message, 'status', 'unknown');
      local reason = std.get(message, 'reason', 'unknown');

      # Check if tedge can be modified to preserve the _ctx property
      local device_id = std.get(meta, 'device_id', '');
      local local_serial = std.split(topic, "/")[1];
      local serial = if std.startsWith(local_serial, device_id) then
          local_serial
        else
          '%s_%s' % [device_id, local_serial]
        ;

      local getTemplate = function(s)
        local states = {
          executing: '501,c8y_SoftwareUpdate',
          successful: '503,c8y_SoftwareUpdate',
          failed: '502,c8y_SoftwareUpdate,"%s"' % reason,
        };
        std.get(states, s, '400,tedge_custom_mapper,"Unexpected operation state. id=%s, state=%s"' % [id, s])
      ;

      local types = std.set([
        item.type
        for item in std.get(message, 'currentSoftwareList', [])
      ]);

      local packages = [
        std.map(
          function(i) i + {type: type},
          std.filter(function(v) v.type == type, message.currentSoftwareList)[0].modules,
        )
        for type in types
      ];

      local toLegacySoftwareList = function(items)
        "116," + std.join(
          ",",
          std.map(
            function(item)
              "%s,%s,%s" % [item.name, item.version, std.get(item, 'url', '')],
            items,
          )
        )
      ;

      local toAdvancedSoftwareList = function(items)
        "140," + std.join(
          ",",
          std.map(
            function(item)
              "%s,%s,%s,%s" % [item.name, item.version, item.type, std.get(item, 'url', '')],
            items,
          )
        )
      ;

      local formatMessage = function(items, mode='')
        if mode == 'legacy' then
          toLegacySoftwareList(items)
        else
          toAdvancedSoftwareList(items)
      ;

      # Control which smart rest template id to use
      # either legacy or advanced. Defaults to advanced.
      local c8ySoftwareMode = '';

      {
        raw_message: getTemplate(status),
        [if std.length(packages) > 0 then 'updates']: [
          {topic: $.topic, message: formatMessage(packages[0], c8ySoftwareMode)},
        ],

        # TODO: replace serial with ctx.serial once the operation schema allow extra fields
        topic: 'c8y/s/us/%s' % serial,
      }
